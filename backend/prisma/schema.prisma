// ──────────────────────────────────────────────────────────
// MOBO – Prisma Schema (PostgreSQL)
// PostgreSQL is the primary and only database.
// 17 models covering the full MOBO domain.
// ──────────────────────────────────────────────────────────

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ────────────────────── ENUMS ──────────────────────

enum UserRole {
  shopper
  mediator
  agency
  brand
  admin
  ops

  @@map("user_role")
}

enum UserStatus {
  active
  suspended
  pending

  @@map("user_status")
}

enum KycStatus {
  none
  pending
  verified
  rejected

  @@map("kyc_status")
}

enum BrandStatus {
  active
  suspended
  pending

  @@map("brand_status")
}

enum AgencyStatus {
  active
  suspended
  pending

  @@map("agency_status")
}

enum OrderWorkflowStatus {
  CREATED
  REDIRECTED
  ORDERED
  PROOF_SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  REWARD_PENDING
  COMPLETED
  FAILED

  @@map("order_workflow_status")
}

enum OrderStatus {
  Ordered
  Shipped
  Delivered
  Cancelled
  Returned

  @@map("order_status")
}

enum PaymentStatus {
  Pending
  Paid
  Refunded
  Failed

  @@map("payment_status")
}

enum AffiliateStatus {
  Unchecked
  Pending_Cooling
  Approved_Settled
  Rejected
  Fraud_Alert
  Cap_Exceeded
  Frozen_Disputed

  @@map("affiliate_status")
}

enum SettlementMode {
  wallet
  external

  @@map("settlement_mode")
}

enum DealType {
  Discount
  Review
  Rating

  @@map("deal_type")
}

enum CampaignStatus {
  draft
  active
  paused
  completed

  @@map("campaign_status")
}

enum TransactionType {
  brand_deposit
  platform_fee
  commission_lock
  commission_settle
  cashback_lock
  cashback_settle
  order_settlement_debit
  commission_reversal
  margin_reversal
  agency_payout
  agency_receipt
  payout_request
  payout_complete
  payout_failed
  refund

  @@map("transaction_type")
}

enum TransactionStatus {
  pending
  completed
  failed
  reversed

  @@map("transaction_status")
}

enum PayoutStatus {
  requested
  processing
  paid
  failed
  canceled
  recorded

  @@map("payout_status")
}

enum Currency {
  INR

  @@map("currency")
}

enum InviteStatus {
  active
  used
  revoked
  expired

  @@map("invite_status")
}

enum TicketStatus {
  Open
  Resolved
  Rejected

  @@map("ticket_status")
}

enum SuspensionAction {
  suspend
  unsuspend

  @@map("suspension_action")
}

enum PushApp {
  buyer
  mediator

  @@map("push_app")
}

enum RejectionType {
  order
  review
  rating
  returnWindow

  @@map("rejection_type")
}

enum MissingProofType {
  review
  rating
  returnWindow

  @@map("missing_proof_type")
}

enum MediatorStatus {
  active
  suspended
  pending

  @@map("mediator_status")
}

// ────────────────────── MODELS ──────────────────────

/// Core user account — all roles share a single User row.
model User {
  id      String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId String? @unique @map("mongo_id") /// Original MongoDB _id for cross-referencing during migration

  name         String  @db.VarChar(120)
  username     String? @unique @db.VarChar(64)
  mobile       String  @db.VarChar(10)
  email        String? @db.VarChar(320)
  passwordHash String  @map("password_hash")

  role   UserRole   @default(shopper)
  roles  UserRole[] @default([shopper])
  status UserStatus @default(active)

  // Ops hierarchy / attribution
  mediatorCode   String?  @map("mediator_code") @db.VarChar(64)
  parentCode     String?  @map("parent_code") @db.VarChar(64)
  generatedCodes String[] @default([]) @map("generated_codes")

  // Consumer specific
  isVerifiedByMediator Boolean @default(false) @map("is_verified_by_mediator")

  // Brand specific
  brandCode         String?  @map("brand_code") @db.VarChar(64)
  connectedAgencies String[] @default([]) @map("connected_agencies")

  // KYC
  kycStatus  KycStatus @default(none) @map("kyc_status")
  kycPanCard String?   @map("kyc_pan_card")
  kycAadhaar String?   @map("kyc_aadhaar")
  kycGst     String?   @map("kyc_gst")

  // Financials
  upiId              String? @map("upi_id")
  qrCode             String? @map("qr_code")
  bankAccountNumber  String? @map("bank_account_number")
  bankIfsc           String? @map("bank_ifsc")
  bankName           String? @map("bank_name")
  bankHolderName     String? @map("bank_holder_name")
  walletBalancePaise Int     @default(0) @map("wallet_balance_paise")
  walletPendingPaise Int     @default(0) @map("wallet_pending_paise")

  // Meta
  avatar String?

  // Account lockout
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockoutUntil        DateTime? @map("lockout_until")

  // Google OAuth
  googleRefreshToken String? @map("google_refresh_token")
  googleEmail        String? @map("google_email") @db.VarChar(320)

  // Audit / soft delete
  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations (self-referential for audit)
  pendingConnections PendingConnection[]
  orders             Order[]             @relation("OrderUser")
  brandOrders        Order[]             @relation("OrderBrandUser")
  wallets            Wallet[]
  payouts            Payout[]
  tickets            Ticket[]
  pushSubscriptions  PushSubscription[]
  suspensionsTarget  Suspension[]        @relation("SuspensionTarget")
  suspensionsAdmin   Suspension[]        @relation("SuspensionAdmin")
  auditLogs          AuditLog[]
  invitesCreated     Invite[]            @relation("InviteCreatedBy")
  mediatorProfile    MediatorProfile?
  shopperProfile     ShopperProfile?

  @@unique([mobile], map: "User_mobile_unique")
  @@index([role])
  @@index([status])
  @@index([parentCode])
  @@index([brandCode, roles])
  @@index([mediatorCode, roles])
  @@index([roles, status])
  // 100k-scale indexes for login + listing queries
  @@index([mobile, deletedAt])               // fast login lookup
  @@index([username, deletedAt])             // fast username login lookup
  @@index([deletedAt, createdAt(sort: Desc)]) // admin user listing
  @@map("users")
}

/// Pending brand-agency connection requests (embedded array in Mongo -> join table in PG)
model PendingConnection {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  agencyId   String?  @map("agency_id")
  agencyName String?  @map("agency_name")
  agencyCode String?  @map("agency_code")
  timestamp  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("pending_connections")
}

/// Brand entity (mirrors Brand.ts)
model Brand {
  id                   String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId              String?     @unique @map("mongo_id")
  name                 String      @db.VarChar(200)
  brandCode            String      @unique @map("brand_code")
  ownerUserId          String      @map("owner_user_id") @db.Uuid
  connectedAgencyCodes String[]    @default([]) @map("connected_agency_codes")
  status               BrandStatus @default(active)

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([status, createdAt(sort: Desc)])
  @@index([deletedAt, status])
  @@index([ownerUserId])
  @@map("brands")
}

/// Agency entity (mirrors Agency.ts)
model Agency {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId     String?      @unique @map("mongo_id")
  name        String       @db.VarChar(200)
  agencyCode  String       @unique @map("agency_code")
  ownerUserId String       @map("owner_user_id") @db.Uuid
  status      AgencyStatus @default(active)

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([status, createdAt(sort: Desc)])
  @@index([deletedAt, status])
  @@index([ownerUserId])
  @@map("agencies")
}

/// Mediator profile (mirrors MediatorProfile.ts)
model MediatorProfile {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId          String?        @unique @map("mongo_id")
  userId           String         @unique @map("user_id") @db.Uuid
  mediatorCode     String         @unique @map("mediator_code")
  parentAgencyCode String?        @map("parent_agency_code")
  status           MediatorStatus @default(active)

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([parentAgencyCode])
  @@map("mediator_profiles")
}

/// Shopper profile (mirrors ShopperProfile.ts)
model ShopperProfile {
  id                  String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId             String? @unique @map("mongo_id")
  userId              String  @unique @map("user_id") @db.Uuid
  defaultMediatorCode String? @map("default_mediator_code")

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([defaultMediatorCode])
  @@map("shopper_profiles")
}

/// Campaign created by a brand (mirrors Campaign.ts)
model Campaign {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId     String? @unique @map("mongo_id")
  title       String  @db.VarChar(200)
  brandUserId String  @map("brand_user_id") @db.Uuid
  brandName   String  @map("brand_name") @db.VarChar(200)
  platform    String  @db.VarChar(80)
  image       String
  productUrl  String  @map("product_url")

  originalPricePaise Int @map("original_price_paise")
  pricePaise         Int @map("price_paise")
  payoutPaise        Int @map("payout_paise")
  returnWindowDays   Int @default(14) @map("return_window_days")

  dealType   DealType?      @map("deal_type")
  totalSlots Int            @map("total_slots")
  usedSlots  Int            @default(0) @map("used_slots")
  status     CampaignStatus @default(draft)

  allowedAgencyCodes String[] @default([]) @map("allowed_agency_codes")

  /// Mediator code -> { limit, payout, commissionPaise }. Stored as JSONB because it is a dynamic Map.
  assignments Json @default("{}")

  locked       Boolean   @default(false)
  lockedAt     DateTime? @map("locked_at")
  lockedReason String?   @map("locked_reason")

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  deals  Deal[]
  orders OrderItem[]

  @@index([status, brandUserId, createdAt(sort: Desc)])
  @@index([brandUserId])
  @@index([deletedAt, createdAt(sort: Desc)])
  @@index([status])
  @@map("campaigns")
}

/// Deal = campaign snapshot for a mediator (mirrors Deal.ts)
model Deal {
  id           String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId      String? @unique @map("mongo_id")
  campaignId   String  @map("campaign_id") @db.Uuid
  mediatorCode String  @map("mediator_code")

  // Snapshot fields
  title       String
  description String @default("Exclusive")
  image       String
  productUrl  String @map("product_url")
  platform    String
  brandName   String @map("brand_name")

  dealType DealType @map("deal_type")

  originalPricePaise Int @map("original_price_paise")
  pricePaise         Int @map("price_paise")
  commissionPaise    Int @map("commission_paise")
  payoutPaise        Int @map("payout_paise")

  rating   Float   @default(5)
  category String  @default("General")
  active   Boolean @default(true)

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, mediatorCode])
  @@index([mediatorCode, createdAt(sort: Desc)])
  @@index([active])
  @@index([deletedAt, active])
  @@map("deals")
}

/// Order (mirrors Order.ts)
model Order {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId     String? @unique @map("mongo_id")
  userId      String  @map("user_id") @db.Uuid
  brandUserId String? @map("brand_user_id") @db.Uuid

  totalPaise Int @map("total_paise")

  workflowStatus OrderWorkflowStatus @default(CREATED) @map("workflow_status")

  // Suspension freeze
  frozen        Boolean   @default(false)
  frozenAt      DateTime? @map("frozen_at")
  frozenReason  String?   @map("frozen_reason")
  reactivatedAt DateTime? @map("reactivated_at")
  reactivatedBy String?   @map("reactivated_by") @db.Uuid

  status          OrderStatus     @default(Ordered)
  paymentStatus   PaymentStatus   @default(Pending) @map("payment_status")
  affiliateStatus AffiliateStatus @default(Unchecked) @map("affiliate_status")

  externalOrderId String? @map("external_order_id")

  // AI-extracted metadata
  orderDate            DateTime? @map("order_date")
  soldBy               String?   @map("sold_by")
  extractedProductName String?   @map("extracted_product_name")

  settlementRef  String?        @map("settlement_ref")
  settlementMode SettlementMode @default(wallet) @map("settlement_mode")

  // Screenshots stored as URLs
  screenshotOrder        String? @map("screenshot_order")
  screenshotPayment      String? @map("screenshot_payment")
  screenshotReview       String? @map("screenshot_review")
  screenshotRating       String? @map("screenshot_rating")
  screenshotReturnWindow String? @map("screenshot_return_window")
  reviewLink             String? @map("review_link")
  returnWindowDays       Int     @default(14) @map("return_window_days")

  // AI verification results (JSONB because deeply nested)
  orderAiVerification        Json? @map("order_ai_verification")
  ratingAiVerification       Json? @map("rating_ai_verification")
  returnWindowAiVerification Json? @map("return_window_ai_verification")

  // Rejection info
  rejectionType   RejectionType? @map("rejection_type")
  rejectionReason String?        @map("rejection_reason")
  rejectionAt     DateTime?      @map("rejection_at")
  rejectionBy     String?        @map("rejection_by") @db.Uuid

  // Verification timestamps (JSONB for nested structure)
  verification Json?

  // Display names
  managerName  String  @map("manager_name")
  agencyName   String? @map("agency_name")
  buyerName    String  @map("buyer_name")
  buyerMobile  String  @map("buyer_mobile") @db.VarChar(10)
  reviewerName String? @map("reviewer_name")
  brandName    String? @map("brand_name")

  // Events log (JSONB array)
  events Json @default("[]")

  // Missing proof requests (JSONB array)
  missingProofRequests Json @default("[]") @map("missing_proof_requests")

  expectedSettlementDate DateTime? @map("expected_settlement_date")

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  user      User        @relation("OrderUser", fields: [userId], references: [id], onDelete: Restrict)
  brandUser User?       @relation("OrderBrandUser", fields: [brandUserId], references: [id], onDelete: Restrict)
  items     OrderItem[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([managerName, createdAt(sort: Desc)])
  @@index([brandUserId, createdAt(sort: Desc)])
  @@index([workflowStatus])
  @@index([frozen])
  @@index([status])
  @@index([paymentStatus])
  @@index([affiliateStatus])
  @@index([settlementMode])
  // 100k-scale composite indexes for common query/filter patterns
  @@index([deletedAt, createdAt(sort: Desc)])     // soft-delete + recent-first listing
  @@index([externalOrderId])                       // duplicate-check during order creation
  @@index([userId, workflowStatus, deletedAt])     // buyer dashboard filtered listing
  @@index([brandUserId, workflowStatus, deletedAt]) // brand dashboard filtered listing
  @@index([managerName, deletedAt, createdAt(sort: Desc)]) // ops dashboard filtered listing
  @@index([buyerMobile, deletedAt])                  // velocity check lookups
  @@map("orders")
}

/// Order item (embedded array in Mongo -> join table in PG)
model OrderItem {
  id                   String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId              String  @map("order_id") @db.Uuid
  productId            String  @map("product_id")
  title                String
  image                String
  priceAtPurchasePaise Int     @map("price_at_purchase_paise")
  commissionPaise      Int     @map("commission_paise")
  campaignId           String  @map("campaign_id") @db.Uuid
  dealType             String? @map("deal_type")
  quantity             Int     @default(1)
  platform             String?
  brandName            String? @map("brand_name")

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([campaignId])
  @@index([productId])
  @@map("order_items")
}

/// Wallet (mirrors Wallet.ts)
model Wallet {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId        String?  @unique @map("mongo_id")
  ownerUserId    String   @unique @map("owner_user_id") @db.Uuid
  currency       Currency @default(INR)
  availablePaise Int      @default(0) @map("available_paise")
  pendingPaise   Int      @default(0) @map("pending_paise")
  lockedPaise    Int      @default(0) @map("locked_paise")
  version        Int      @default(0)

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  owner        User          @relation(fields: [ownerUserId], references: [id], onDelete: Restrict)
  transactions Transaction[]
  payouts      Payout[]

  @@map("wallets")
}

/// Financial transaction (mirrors Transaction.ts)
model Transaction {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId        String?           @unique @map("mongo_id")
  idempotencyKey String            @unique @map("idempotency_key")
  type           TransactionType
  status         TransactionStatus @default(pending)
  amountPaise    Int               @map("amount_paise")
  currency       String            @default("INR")

  orderId    String? @map("order_id") @db.VarChar(64)
  campaignId String? @map("campaign_id") @db.Uuid
  payoutId   String? @map("payout_id") @db.Uuid
  walletId   String? @map("wallet_id") @db.Uuid
  fromUserId String? @map("from_user_id") @db.Uuid
  toUserId   String? @map("to_user_id") @db.Uuid

  metadata Json?

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  wallet Wallet? @relation(fields: [walletId], references: [id])

  @@index([status, type, createdAt(sort: Desc)])
  @@index([deletedAt, createdAt(sort: Desc)])
  @@index([walletId, createdAt(sort: Desc)])
  @@index([orderId])
  @@index([campaignId])
  @@index([payoutId])
  @@index([fromUserId])
  @@index([toUserId])
  @@map("transactions")
}

/// Payout request (mirrors Payout.ts)
model Payout {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId           String?      @unique @map("mongo_id")
  beneficiaryUserId String       @map("beneficiary_user_id") @db.Uuid
  walletId          String       @map("wallet_id") @db.Uuid
  amountPaise       Int          @map("amount_paise")
  currency          String       @default("INR")
  status            PayoutStatus @default(requested)

  provider    String?
  providerRef String? @map("provider_ref")

  failureCode    String? @map("failure_code")
  failureMessage String? @map("failure_message")

  requestedAt DateTime  @default(now()) @map("requested_at")
  processedAt DateTime? @map("processed_at")

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  beneficiary User   @relation(fields: [beneficiaryUserId], references: [id], onDelete: Restrict)
  wallet      Wallet @relation(fields: [walletId], references: [id], onDelete: Restrict)

  @@unique([provider, providerRef])
  @@index([status, requestedAt(sort: Desc)])
  @@index([beneficiaryUserId, requestedAt(sort: Desc)])
  @@index([walletId])
  @@map("payouts")
}

/// Invite code (mirrors Invite.ts)
model Invite {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId String?  @unique @map("mongo_id")
  code    String   @unique
  role    UserRole
  label   String?

  parentUserId String? @map("parent_user_id") @db.Uuid
  parentCode   String? @map("parent_code")

  status InviteStatus @default(active)

  maxUses  Int @default(1) @map("max_uses")
  useCount Int @default(0) @map("use_count")

  expiresAt DateTime? @map("expires_at")

  createdBy String?   @map("created_by") @db.Uuid
  usedBy    String?   @map("used_by") @db.Uuid
  usedAt    DateTime? @map("used_at")

  /// Array of { usedBy, usedAt } stored as JSONB
  uses Json @default("[]")

  revokedBy String?   @map("revoked_by") @db.Uuid
  revokedAt DateTime? @map("revoked_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  creator User? @relation("InviteCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([status, expiresAt])
  @@index([code, status, useCount])
  @@index([parentCode, status, createdAt(sort: Desc)])
  @@map("invites")
}

/// Support ticket (mirrors Ticket.ts)
model Ticket {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId     String?      @unique @map("mongo_id")
  userId      String       @map("user_id") @db.Uuid
  userName    String       @map("user_name")
  role        String
  orderId     String?      @map("order_id")
  issueType   String       @map("issue_type")
  description String
  status      TicketStatus @default(Open)

  resolvedBy     String?   @map("resolved_by") @db.Uuid
  resolvedAt     DateTime? @map("resolved_at")
  resolutionNote String?   @map("resolution_note") @db.VarChar(1000)

  createdBy String?   @map("created_by") @db.Uuid
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([status, createdAt(sort: Desc)])
  @@index([userId, deletedAt, createdAt(sort: Desc)]) // user-specific ticket listing
  @@map("tickets")
}

/// Push notification subscription (mirrors PushSubscription.ts)
model PushSubscription {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId        String? @unique @map("mongo_id")
  userId         String  @map("user_id") @db.Uuid
  app            PushApp
  endpoint       String  @unique
  expirationTime Int?    @map("expiration_time")
  keysP256dh     String  @map("keys_p256dh")
  keysAuth       String  @map("keys_auth")
  userAgent      String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, app])
  @@map("push_subscriptions")
}

/// Admin suspension / unsuspension record (mirrors Suspension.ts)
model Suspension {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId      String?          @unique @map("mongo_id")
  targetUserId String           @map("target_user_id") @db.Uuid
  action       SuspensionAction
  reason       String?
  adminUserId  String           @map("admin_user_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  target User @relation("SuspensionTarget", fields: [targetUserId], references: [id], onDelete: Restrict)
  admin  User @relation("SuspensionAdmin", fields: [adminUserId], references: [id], onDelete: Restrict)

  @@index([targetUserId, createdAt(sort: Desc)])
  @@map("suspensions")
}

/// Audit log (mirrors AuditLog.ts)
model AuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId     String?  @unique @map("mongo_id")
  actorUserId String?  @map("actor_user_id") @db.Uuid
  actorRoles  String[] @default([]) @map("actor_roles")
  action      String
  entityType  String?  @map("entity_type")
  entityId    String?  @map("entity_id")
  ip          String?
  userAgent   String?  @map("user_agent")
  metadata    Json?

  createdAt DateTime @default(now()) @map("created_at")

  actor User? @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([createdAt(sort: Desc), action])
  @@index([entityType, entityId, createdAt(sort: Desc)])
  @@index([actorUserId, createdAt(sort: Desc)])
  @@map("audit_logs")
}

/// System configuration key-value (mirrors SystemConfig.ts)
model SystemConfig {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mongoId           String? @unique @map("mongo_id")
  key               String  @unique @default("system")
  adminContactEmail String? @map("admin_contact_email")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

/// Migration sync tracking for backfilling Mongo data to PG (per-collection).
model MigrationSync {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  collection  String    @unique
  status      String    @default("pending")
  syncedCount Int       @default(0) @map("synced_count")
  errorCount  Int       @default(0) @map("error_count")
  lastSyncAt  DateTime? @map("last_sync_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([status])
  @@map("migration_sync")
}
